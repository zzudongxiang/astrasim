# ASTRA-sim 安装教程

**源码细节正在调试，暂未开放，欢迎邮件沟通 [zzudongxiang@163.com](mailto:zzudongxiang@163.com)**

**源码细节正在调试，暂未开放，欢迎邮件沟通 [zzudongxiang@163.com](mailto:zzudongxiang@163.com)**

**源码细节正在调试，暂未开放，欢迎邮件沟通 [zzudongxiang@163.com](mailto:zzudongxiang@163.com)**

ASTRA-sim 是一个分布式机器学习系统模拟器。它可以系统地研究现代深度学习系统所面临的挑战，探索瓶颈问题，并为未来不同平台上开发大型 DNN 模型提供高效的方法。

![astra_sim_overview](../images/astra_sim_overview.png)

> [!CAUTION]
>
> - 使用`gcc -v`检查gcc版本，如果超过gcc-11，后续的工作可能会遇到编译错误！！！
> - 请勿使用root用户编译ASTRA-sim项目，可能会导致ns-3模块编译失败！！！

## 1. 安装依赖

- 使用apt安装系统依赖组件

  ```bash
  # 更新apt源
  apt update
  apt upgrade
  # 使用apt安装依赖
  apt install -y gcc g++ make cmake mpich gdb
  apt install -y nano git git-lfs python3 python3-pip
  apt install -y libboost-dev libboost-program-options-dev
  apt install -y libprotobuf-dev protobuf-compiler
  ```

- 安装conda环境 **（可选）**

  ```bash
  # 创建conda环境
  conda create -n astra-sim python=3.7 -y
  # 激活conda环境
  conda activate astra-sim
  ```

  **注意：** 如果使用Conda管理Python，则后续的操作都需要在Conda的`astra-sim`环境中进行

- 安装python依赖

  ```bash
  # 更新pip工具
  pip install --upgrade pip
  # 安装python组件
  pip install protobuf==3.6.1 pydot -i https://pypi.tuna.tsinghua.edu.cn/simple
  pip install pandas matplotlib seaborn -i https://pypi.tuna.tsinghua.edu.cn/simple
  ```

- 如果当前以root用户进行操作，请使用如下方法创建并进入非root用户 **（可选）**

  ```bash
  # 创建名字为astrasim的普通用户
  adduser astrasim
  # 切换到astrasim用户
  su astrasim
  ```

  - 可以使用`cp -r <src_path> <dst_path>`命令创建一份副本 **（可选）**
  - 可以使用`chown -R <user> <path>`和`chgrp -R <group> <path>`更改文件夹的所有权

## 2. 编译项目

- 更新本仓库所依赖的子模块内容

  ```bash
  git submodule update --init --recursive
  ```
  
- 使用预定义的脚本编译和验证项目

  ```bash
  # 编译并验证Analytical网络后端
  bash ./script/build_analytical.sh -a
  # 编译并验证NS3网络后端
  bash ./script/build_ns3.sh -a
  ```
  
- 在编译的时候可以使用如下命令分别进行编译和验证 **（可选）**

  ```bash
  # 清理历史编译的缓存文件
  bash ./script/<build_script> -l
  # 仅编译，如果存在缓存则使用缓存进行编译，编译后不进行测试
  bash ./script/<build_script> -c
  # 验证编译结果，运行验证脚本
  bash ./script/<build_script> -v
  ```

## 3. 常见问题

- **extern/…/gtest-death-test.cc:1294:24: error: ‘dummy’ may be used uninitialized…**

  打开文件`astra-sim/extern/googletest/googletest/src/gtest-death-test.cc`找到第`1294`行，发现这里的函数调用之前只做了声明，未进行赋值，给参数`dump`一个默认值`0`即可

  ![image-20240529192151756](../images/image-20240529192151756.png)

- **extern/…/ChunkIdGenerator.hh:16:23: error: ‘uint64_t’ does not name a type…**

  打开文件`astra-sim/extern/network_backend/analytical/congestion/api/ChunkIdGenerator.hh`并在文件的第11行添加`#include <cstdint>`

  ![image-20240529192630456](../images/image-20240529192630456.png)

- **extern/…/et_def.pb.h:17:2: error: #error This file was generated by an older…**

  一般是protoc工具的版本问题，如果使用的是Anaconda环境，需要检查环境是否正确，如果不正确的话，请使用`conda avtivate astra-sim`激活已经配置好的Anaconda环境

- **Exception: Refusing to run as root. --enable-sudo will request your password when needed**

  一般是因为使用了root用户进行编译操作导致的，请勿使用root用户登录并编译该文件，请切换为普通用户后尝试


- **AnalyticalAstra: /…libstdc++.so.6: version `GLIBCXX_3.4.32' not found…**

  使用`strings xxx/anaconda3/lib/libstdc++.so.6 | grep GLIBCXX`发现输出的GLIBC版本中缺少指定的3.4.32版本的标记，通过`find /usr -name libstdc++.so.6`搜索其他`libstdc++.so.6`文件所在的位置，并使用如下命令将其导入动态链接库环境变量中即可

  ```bash
  # 如有必要，可以将以下内容添加至~/.bashrc文件中
  export LD_LIBRARY_PATH=/usr/lib/x86_64-linux-gnu:$LD_LIBRARY_PATH
  ```

